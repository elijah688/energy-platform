<!-- Top users grid -->
<div class="users-grid">
  <!-- Search bar -->
  <div class="search-bar" style="margin-bottom: 1rem;">
    <input type="text" matInput placeholder="Search users by name" (input)="onSearch($event)" />
  </div>

  @for (user of userServ.users(); track $index) {
  <mat-card class="user-card">
    <!-- User Info -->
    <div class="user-info">
      <div>Name: {{ user.name }}</div>
      <div>Balance: {{ user.balance }}</div>
      <div>Energy Stored: {{ user.energyStored }}</div>
      <div>Id: {{ user.id }}</div>
      <div>Created At: {{ user.createdAt }}</div>
      <div>Updated At: {{ user.updatedAt }}</div>
    </div>

    <button mat-raised-button color="primary" (click)="userServ.selectUser(user)"
      [disabled]="userServ.selecterUsers().length >= 2">
      Select
    </button>

    <mat-accordion #userAcc multi class="user-panel">
      <!-- Generators Panel -->
      <mat-expansion-panel (opened)="fetchUserGenerators(user.id)">
        <mat-expansion-panel-header>
          <mat-panel-title>
            Generators
          </mat-panel-title>
        </mat-expansion-panel-header>

        @for (gen of (genService.generators()[user.id] || []); track $index) {
        <mat-card class="generator-card">
          <div>Type: {{ gen.type }}</div>
          <div>Production Rate: {{ gen.productionRate }}</div>
          <div>Status: {{ gen.status }}</div>
          <div>Last Generated: {{ gen.lastGeneratedAt || 'Never' }}</div>
        </mat-card>
        } @empty {
        <p>No generators for this user.</p>
        }

        <!-- Generator pagination buttons -->
        <div class="pagination">
          <button mat-button (click)="prevUserGenPage(user.id)"
            [disabled]="(genService.userPagination()[user.id]?.offset || 0) === 0">
            Previous
          </button>

          <button mat-button (click)="nextUserGenPage(user.id)"
            [disabled]="(genService.generators()[user.id]?.length || 0) < (genService.userPagination()[user.id]?.limit || 1)">
            Next
          </button>
        </div>
      </mat-expansion-panel>


      <!-- Transactions Panel -->
      <mat-expansion-panel (opened)="fetchUserTransactions(user.id)">
        <mat-expansion-panel-header>
          <mat-panel-title>
            Transactions
          </mat-panel-title>
        </mat-expansion-panel-header>

        @for (tx of (transService.transactions()[user.id] || []); track $index) {
        <mat-card class="transaction-card">
          <div>Seller: {{ tx.sellerId }}</div>
          <div>Buyer: {{ tx.buyerId || 'Market' }}</div>
          <div>Energy: {{ tx.energyAmount }} kWh</div>
          <div>Price: {{ tx.pricePerKwh }}</div>
          <div>Total: {{ tx.totalPrice }}</div>
        </mat-card>
        } @empty {
        <p>End of user transactions.</p>
        }

        <!-- Transaction pagination buttons -->
        <div class="pagination">
          <button mat-button (click)="prevUserTxPage(user.id)"
            [disabled]="(transService.userPagination()[user.id]?.offset || 0) === 0">
            Previous
          </button>

          <button mat-button (click)="nextUserTxPage(user.id)"
            [disabled]="(transService.transactions()[user.id]?.length || 0) < (transService.userPagination()[user.id]?.limit || 50)">
            Next
          </button>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  </mat-card>
  } @empty {
  <p>End of users.</p>
  }
</div>

<!-- Users pagination buttons -->
<div class="pagination">
  <button mat-raised-button (click)="prevPage()" [disabled]="userServ.offset === 0">
    Previous
  </button>
  <button mat-raised-button (click)="nextPage()">
    Next
  </button>
</div>

<!-- Selected users for transaction -->
@if (userServ.selecterUsers().length > 0) {
<div class="transaction-header">
  <h3>Selected Users for Transaction</h3>
</div>

<div class="transaction-users-grid">
  @for (user of userServ.selecterUsers(); track $index) {
  <mat-card class="user-card picked">
    <div class="user-info">
      <div>Name: {{ user.name }}</div>
      <div>Balance: {{ user.balance }}</div>
      <div>Energy Stored: {{ user.energyStored }}</div>
      <div>Id: {{ user.id }}</div>
    </div>
    <button mat-raised-button color="warn" (click)="userServ.deselectUser(user)">
      Remove
    </button>
  </mat-card>
  }
</div>

@if (userServ.selecterUsers().length === 2) {
<div class="trade-button" style="text-align: center; margin-top: 1rem;">
  <button mat-raised-button color="accent" [routerLink]="'/trade'">
    Proceed to Trade
  </button>
</div>
}
}
